// Copyright (c) 2016-2018 Clearmatics Technologies Ltd
// SPDX-License-Identifier: LGPL-3.0+

/*
    Fabric Storage contract test

    Tests here are standalone unit tests for Ion functionality.
    Other contracts have been mocked to simulate basic behaviour.

    Tests Fabric block structure decoding and verification of state transitions.
*/

const rlp = require('rlp');
const async = require('async')
const util = require('util');

// Connect to the Test RPC running
const Web3 = require('web3');
const web3 = new Web3();
web3.setProvider(new web3.providers.HttpProvider('http://localhost:8545'));

const MockIon = artifacts.require("MockIon");
const CordaStore = artifacts.require("CordaStore");

require('chai')
 .use(require('chai-as-promised'))
 .should();

const DEPLOYEDCHAINID = "0xab830ae0774cb20180c8b463202659184033a9f30a21550b89a2b406c3ac8075"
const TESTCHAINID = "0x22b55e8a4f7c03e1689da845dd463b09299cb3a574e64c68eafc4e99077a7254"

const TEST_TX_HASH = "0xA9B814B053171818339C65997EA61A97FCCD71D0ABE38CD0FA58690C8932FEB7"
const TEST_TX_BLOB = "0x636f7264610100000080c562000000000001d000002c730000000300a3226e65742e636f7264613a38674f537471464b414a5055656f63667633536553513d3dd0000023360000000200a3226e65742e636f7264613a472b4967336176636a65344b586b337772636a4445513d3dd0000001d60000000200a3226e65742e636f7264613a7966622b3236685a4e3857346f3345716c635a366a673d3dc0c20400a3216e65742e636f7264613a6a6176612e73656375726974792e5075626c69634b6579a02c302a300506032b65700321008e0aacedfae1a52006399559d02e377684606e36cca1f1ad6bc5d86910a12567a040c48244543bb8116b9dbdfc76abf5849cbfb596ca66daeb164434f010e144fd0bdd49df7de3e09cb87f6e750fbb0aa162e9a15f2f7bcafa060aa6ad7831331b0a4000a3226e65742e636f7264613a497a46743863524b7974734a713376512b796a7347673d3dc005025403540400a3226e65742e636f7264613a7966622b3236685a4e3857346f3345716c635a366a673d3dc0c20400a3216e65742e636f7264613a6a6176612e73656375726974792e5075626c69634b6579a02c302a300506032b657003210095f374752009500ccf92ea5251f96ca17d05f659815fc9f10819ab80dbf5af7ca040bdbd35e53859c49db90b23a80c9e8b03633cd204cdd51f12724a7c17c5965b8b0c527d16185442aea14fb4dda8485b8847857fa63e8b3ab398ff96c18bc1ff084000a3226e65742e636f7264613a497a46743863524b7974734a713376512b796a7347673d3dc005025403540400a3226e65742e636f7264613a4c4f3042534e2b3378334a4e354f4d724d4e55376a413d3dd00000210800000001b0000020ff636f7264610100000080c562000000000001d0000020e80000000300a3226e65742e636f7264613a584f6f3558726e30316d63566a6f6b496c4831656b413d3dd000001bd80000000200a3226e65742e636f7264613a534c7758304d6874704f6f574f714c2f42646a2f76513d3dd000001b600000000500a3226e65742e636f7264613a486e6553504138394d476870697a564c453377634f673d3dd0000010be0000000200a3226e65742e636f7264613a4a597065626c59374372782f61314a6968784a4336773d3dd00000108e0000000100a3226e65742e636f7264613a4c5935355955446a784f38344f6c775377557a7653413d3dd00000106000000001b000001057636f7264610100000080c562000000000001d0000010400000000300a3226e65742e636f7264613a51307a55474e2f4b367777777975496c4e66335261773d3dd00000042a0000000500a3226e65742e636f7264613a676b49465648487262546861684f46773472504d45513d3dc04b0100a3226e65742e636f7264613a37595a535555337443365976745833334b6c6f394a673d3dc02301a02033474773bfc28953e02f87207f614bbdc5fdb225f96af51d45c738ae87d7cfeea1276e65742e636f7264612e747261696e696e672e636f6e74726163742e494f55436f6e747261637400a3226e65742e636f7264613a396d58416531504d2b57593477564168456679634a513d3dd0000002a90000000500a3226e65742e636f7264613a7671776d796f644a4f586a34465243314b6d417838413d3dc0550300a31e6e65742e636f7264613a6a6176612e6d6174682e426967446563696d616ca104302e30318100000000000003e800a31c6e65742e636f7264613a6a6176612e7574696c2e43757272656e6379a10355534400a3226e65742e636f7264613a48394b4f69386167557573674b4b69334d45423378673d3dc0a40200a3226e65742e636f7264613a6e6764776274366b5254306c356e6e313675663837413d3dc02a0640a1024742a1094c69766572706f6f6ca11542616e6b206f6620427265616b6661737420546561404000a3216e65742e636f7264613a6a6176612e73656375726974792e5075626c69634b6579a02c302a300506032b65700321008e0aacedfae1a52006399559d02e377684606e36cca1f1ad6bc5d86910a1256700a3226e65742e636f7264613a48394b4f69386167557573674b4b69334d45423378673d3dc0a00200a3226e65742e636f7264613a6e6764776274366b5254306c356e6e313675663837413d3dc0260640a1025553a1084e657720596f726ba11242616e6b206f6620426967204170706c6573404000a3216e65742e636f7264613a6a6176612e73656375726974792e5075626c69634b6579a02c302a300506032b657003210095f374752009500ccf92ea5251f96ca17d05f659815fc9f10819ab80dbf5af7c00a3226e65742e636f7264613a726e69773742324d7169377a6c6b50704b6d4a3737413d3dc0130240988696627b84024fa0a4ddf16b11c843c500a3226e65742e636f7264613a7671776d796f644a4f586a34465243314b6d417838413d3dc0360300a31e6e65742e636f7264613a6a6176612e6d6174682e426967446563696d616ca104302e303155000080c56200000000000852034000a3226e65742e636f7264613a48394b4f69386167557573674b4b69334d45423378673d3dc0900200a3226e65742e636f7264613a6e6764776274366b5254306c356e6e313675663837413d3dc0160640a1024954a104526f6d65a1064e6f74617279404000a3216e65742e636f7264613a6a6176612e73656375726974792e5075626c69634b6579a02c302a300506032b6570032100bd4d8aaa3e6ca206202286e243621107d16577b9899c6e9f7b4ba1565ec798480080c562000000000002d000000bcc00000001d000000bc30000000c0080c562000000000005d00000018400000005a1296e65742e636f7264612e636f72652e636f6e7472616374732e5472616e73616374696f6e537461746540450080c562000000000003c02602a3226e65742e636f7264613a51307a55474e2f4b367777777975496c4e66335261773d3d40d00000011c000000050080c562000000000004c04607a10a636f6e73747261696e74a1012ac03001a12d6e65742e636f7264612e636f72652e636f6e7472616374732e4174746163686d656e74436f6e73747261696e74404041420080c562000000000004c01807a108636f6e7472616374a106737472696e6745404041420080c562000000000004c03907a10464617461a1012ac02901a1266e65742e636f7264612e636f72652e636f6e7472616374732e436f6e74726163745374617465404041420080c562000000000004c01807a10b656e63756d6272616e6365a103696e7445404042420080c562000000000004c02d07a1066e6f74617279a11d6e65742e636f7264612e636f72652e6964656e746974792e506172747945404041420080c562000000000005c09605a12d6e65742e636f7264612e636f72652e636f6e7472616374732e4174746163686d656e74436f6e73747261696e7440c03001a12d6e65742e636f7264612e636f72652e636f6e7472616374732e4174746163686d656e74436f6e73747261696e740080c562000000000003c02602a3226e65742e636f7264613a4d6766362f7332416a6b5a6154382f6255396e4e53513d3d40450080c562000000000005c08805a1266e65742e636f7264612e636f72652e636f6e7472616374732e436f6e7472616374537461746540c02901a1266e65742e636f7264612e636f72652e636f6e7472616374732e436f6e747261637453746174650080c562000000000003c02602a3226e65742e636f7264613a5a326932426d6f35324566756346585a3842324350513d3d40450080c562000000000005c0d105a11d6e65742e636f7264612e636f72652e6964656e746974792e506172747940450080c562000000000003c02602a3226e65742e636f7264613a48394b4f69386167557573674b4b69334d45423378673d3d40c07b020080c562000000000004c03307a1046e616d65a1256e65742e636f7264612e636f72652e6964656e746974792e436f726461583530304e616d6545404041420080c562000000000004c02f07a1096f776e696e674b6579a1012ac01a01a1176a6176612e73656375726974792e5075626c69634b6579404041420080c562000000000005d00000014400000005a1256e65742e636f7264612e636f72652e6964656e746974792e436f726461583530304e616d6540450080c562000000000003c02602a3226e65742e636f7264613a6e6764776274366b5254306c356e6e313675663837413d3d40c0e3060080c562000000000004c01a07a10a636f6d6d6f6e4e616d65a106737472696e6745404042420080c562000000000004c01707a107636f756e747279a106737472696e6745404041420080c562000000000004c01807a1086c6f63616c697479a106737472696e6745404041420080c562000000000004c01c07a10c6f7267616e69736174696f6ea106737472696e6745404041420080c562000000000004c02007a1106f7267616e69736174696f6e556e6974a106737472696e6745404042420080c562000000000004c01507a1057374617465a106737472696e6745404042420080c562000000000005c0de05a1316e65742e636f7264612e636f72652e636f6e7472616374732e486173684174746163686d656e74436f6e73747261696e7440c03001a12d6e65742e636f7264612e636f72652e636f6e7472616374732e4174746163686d656e74436f6e73747261696e740080c562000000000003c02602a3226e65742e636f7264613a676b49465648487262546861684f46773472504d45513d3d40c043010080c562000000000004c03607a10c6174746163686d656e744964a1206e65742e636f7264612e636f72652e63727970746f2e5365637572654861736845404041420080c562000000000005c0bb05a1206e65742e636f7264612e636f72652e63727970746f2e5365637572654861736840450080c562000000000003c02602a3226e65742e636f7264613a62373950654d424c73487875324132337944595261413d3d40c062030080c562000000000004c01507a1056279746573a10662696e61727945404041420080c562000000000004c01507a1066f6666736574a103696e7445a101304041420080c562000000000004c01307a10473697a65a103696e7445a101304041420080c562000000000005c08205a1276e65742e636f7264612e636f72652e63727970746f2e536563757265486173682453484132353640450080c562000000000003c02602a3226e65742e636f7264613a37595a535555337443365976745833334b6c6f394a673d3d40c022010080c562000000000004c01507a1056279746573a10662696e61727945404041420080c562000000000005d00000020b00000005a1216e65742e636f7264612e747261696e696e672e73746174652e494f55537461746540c04f02a1246e65742e636f7264612e636f72652e636f6e7472616374732e4c696e6561725374617465a1266e65742e636f7264612e636f72652e636f6e7472616374732e436f6e747261637453746174650080c562000000000003c02602a3226e65742e636f7264613a396d58416531504d2b57593477564168456679634a513d3d40d00000015b000000050080c562000000000004c04307a106616d6f756e74a1336e65742e636f7264612e636f72652e636f6e7472616374732e416d6f756e743c6a6176612e7574696c2e43757272656e63793e45404041420080c562000000000004c02f07a108626f72726f776572a11d6e65742e636f7264612e636f72652e6964656e746974792e506172747945404041420080c562000000000004c02d07a1066c656e646572a11d6e65742e636f7264612e636f72652e6964656e746974792e506172747945404041420080c562000000000004c03b07a1086c696e6561724964a1296e65742e636f7264612e636f72652e636f6e7472616374732e556e697175654964656e74696669657245404041420080c562000000000004c04107a10470616964a1336e65742e636f7264612e636f72652e636f6e7472616374732e416d6f756e743c6a6176612e7574696c2e43757272656e63793e45404041420080c562000000000005c0ac05a1246e65742e636f7264612e636f72652e636f6e7472616374732e4c696e656172537461746540c04f02a1246e65742e636f7264612e636f72652e636f6e7472616374732e4c696e6561725374617465a1266e65742e636f7264612e636f72652e636f6e7472616374732e436f6e747261637453746174650080c562000000000003c02602a3226e65742e636f7264613a416a4d5a704d6f6a5268685a36364a6b7433576243413d3d40450080c562000000000005c0f805a1336e65742e636f7264612e636f72652e636f6e7472616374732e416d6f756e743c6a6176612e7574696c2e43757272656e63793e40450080c562000000000003c02602a3226e65742e636f7264613a7671776d796f644a4f586a34465243314b6d417838413d3d40c08c030080c562000000000004c02e07a110646973706c6179546f6b656e53697a65a1146a6176612e6d6174682e426967446563696d616c45404041420080c562000000000004c01807a1087175616e74697479a1046c6f6e6745a101304041420080c562000000000004c02107a105746f6b656ea1126a6176612e7574696c2e43757272656e637945404041420080c562000000000005c0a505a1296e65742e636f7264612e636f72652e636f6e7472616374732e556e697175654964656e74696669657240450080c562000000000003c02602a3226e65742e636f7264613a726e69773742324d7169377a6c6b50704b6d4a3737413d3d40c043020080c562000000000004c01a07a10a65787465726e616c4964a106737472696e6745404042420080c562000000000004c01007a1026964a1047575696445404041420080c562000000000009c10100540100a3226e65742e636f7264613a486e6553504138394d476870697a564c453377634f673d3dd0000003030000000200a3226e65742e636f7264613a4a597065626c59374372782f61314a6968784a4336773d3dd0000002d30000000100a3226e65742e636f7264613a4c5935355955446a784f38344f6c775377557a7653413d3dd0000002a500000001b00000029c636f7264610100000080c562000000000001d0000002850000000300a3226e65742e636f7264613a6e577a4c4168314d63536a2f596f7550335a72704e413d3d450080c562000000000002d00000023f00000001d000000236000000030080c562000000000005c0c805a1366e65742e636f7264612e747261696e696e672e636f6e74726163742e494f55436f6e747261637424436f6d6d616e647324497373756540c05902a1306e65742e636f7264612e747261696e696e672e636f6e74726163742e494f55436f6e747261637424436f6d6d616e6473a1246e65742e636f7264612e636f72652e636f6e7472616374732e436f6d6d616e64446174610080c562000000000003c02602a3226e65742e636f7264613a6e577a4c4168314d63536a2f596f7550335a72704e413d3d40450080c562000000000005c0c205a1306e65742e636f7264612e747261696e696e672e636f6e74726163742e494f55436f6e747261637424436f6d6d616e647340c05902a1306e65742e636f7264612e747261696e696e672e636f6e74726163742e494f55436f6e747261637424436f6d6d616e6473a1246e65742e636f7264612e636f72652e636f6e7472616374732e436f6d6d616e64446174610080c562000000000003c02602a3226e65742e636f7264613a67356d463477484479445779774957527762595173773d3d40450080c562000000000005c08405a1246e65742e636f7264612e636f72652e636f6e7472616374732e436f6d6d616e644461746140c02701a1246e65742e636f7264612e636f72652e636f6e7472616374732e436f6d6d616e64446174610080c562000000000003c02602a3226e65742e636f7264613a66713652502f6633746a44686f6a30597836697041673d3d40450080c562000000000009c10100540200a3226e65742e636f7264613a486e6553504138394d476870697a564c453377634f673d3dd0000001710000000200a3226e65742e636f7264613a4a597065626c59374372782f61314a6968784a4336773d3dd0000001410000000100a3226e65742e636f7264613a4c5935355955446a784f38344f6c775377557a7653413d3dd00000011300000001b00000010a636f7264610100000080c562000000000001c0f60300a3226e65742e636f7264613a37595a535555337443365976745833334b6c6f394a673d3dc02301a02033474773bfc28953e02f87207f614bbdc5fdb225f96af51d45c738ae87d7cfee0080c562000000000002c09201c08f010080c562000000000005c08205a1276e65742e636f7264612e636f72652e63727970746f2e536563757265486173682453484132353640450080c562000000000003c02602a3226e65742e636f7264613a37595a535555337443365976745833334b6c6f394a673d3d40c022010080c562000000000004c01507a1056279746573a10662696e61727945404041420080c562000000000009c10100540300a3226e65742e636f7264613a486e6553504138394d476870697a564c453377634f673d3dd0000003920000000200a3226e65742e636f7264613a4a597065626c59374372782f61314a6968784a4336773d3dd0000003620000000100a3226e65742e636f7264613a4c5935355955446a784f38344f6c775377557a7653413d3dd00000033400000001b00000032b636f7264610100000080c562000000000001d0000003140000000300a3226e65742e636f7264613a48394b4f69386167557573674b4b69334d45423378673d3dc0900200a3226e65742e636f7264613a6e6764776274366b5254306c356e6e313675663837413d3dc0160640a1024954a104526f6d65a1064e6f74617279404000a3216e65742e636f7264613a6a6176612e73656375726974792e5075626c69634b6579a02c302a300506032b6570032100bd4d8aaa3e6ca206202286e243621107d16577b9899c6e9f7b4ba1565ec798480080c562000000000002d00000023d00000001d000000234000000020080c562000000000005c0d105a11d6e65742e636f7264612e636f72652e6964656e746974792e506172747940450080c562000000000003c02602a3226e65742e636f7264613a48394b4f69386167557573674b4b69334d45423378673d3d40c07b020080c562000000000004c03307a1046e616d65a1256e65742e636f7264612e636f72652e6964656e746974792e436f726461583530304e616d6545404041420080c562000000000004c02f07a1096f776e696e674b6579a1012ac01a01a1176a6176612e73656375726974792e5075626c69634b6579404041420080c562000000000005d00000014400000005a1256e65742e636f7264612e636f72652e6964656e746974792e436f726461583530304e616d6540450080c562000000000003c02602a3226e65742e636f7264613a6e6764776274366b5254306c356e6e313675663837413d3d40c0e3060080c562000000000004c01a07a10a636f6d6d6f6e4e616d65a106737472696e6745404042420080c562000000000004c01707a107636f756e747279a106737472696e6745404041420080c562000000000004c01807a1086c6f63616c697479a106737472696e6745404041420080c562000000000004c01c07a10c6f7267616e69736174696f6ea106737472696e6745404041420080c562000000000004c02007a1106f7267616e69736174696f6e556e6974a106737472696e6745404042420080c562000000000004c01507a1057374617465a106737472696e6745404042420080c562000000000009c10100540400a3226e65742e636f7264613a486e6553504138394d476870697a564c453377634f673d3dd0000001c60000000200a3226e65742e636f7264613a4a597065626c59374372782f61314a6968784a4336773d3dd0000001960000000100a3226e65742e636f7264613a4c5935355955446a784f38344f6c775377557a7653413d3dd00000016800000001b00000015f636f7264610100000080c562000000000001d0000001480000000300a3226e65742e636f7264613a5264366878672b306f4a524f784b44584b384f6572413d3dc0a50200a3216e65742e636f7264613a6a6176612e73656375726974792e5075626c69634b6579a02c302a300506032b657003210095f374752009500ccf92ea5251f96ca17d05f659815fc9f10819ab80dbf5af7c00a3216e65742e636f7264613a6a6176612e73656375726974792e5075626c69634b6579a02c302a300506032b65700321008e0aacedfae1a52006399559d02e377684606e36cca1f1ad6bc5d86910a125670080c562000000000002c05f01c05c010080c562000000000006c04f06a1116a6176612e7574696c2e4c6973743c3f3e4045a1046c6973740080c562000000000003c02602a3226e65742e636f7264613a5264366878672b306f4a524f784b44584b384f6572413d3d40450080c562000000000009c10100540600a3226e65742e636f7264613a31736b5566426163553141676d4c58384d317a3833413d3dc02301a02087a068ad5eae90fa6c13a1d001b5f58c6bf991c5bf3de4ba54819e0a7022ed7c0080c562000000000002d0000004c600000001d0000004bd000000070080c562000000000005d00000011100000005a12b6e65742e636f7264612e636f72652e7472616e73616374696f6e732e576972655472616e73616374696f6e40450080c562000000000003c02602a3226e65742e636f7264613a584f6f3558726e30316d63566a6f6b496c4831656b413d3d40c0aa020080c562000000000004c05807a10f636f6d706f6e656e7447726f757073a1012ac03d01a13a6a6176612e7574696c2e4c6973743c6e65742e636f7264612e636f72652e7472616e73616374696f6e732e436f6d706f6e656e7447726f75703e404041420080c562000000000004c03907a10b7072697661637953616c74a1246e65742e636f7264612e636f72652e636f6e7472616374732e5072697661637953616c7445404041420080c562000000000006c07806a13a6a6176612e7574696c2e4c6973743c6e65742e636f7264612e636f72652e7472616e73616374696f6e732e436f6d706f6e656e7447726f75703e4045a1046c6973740080c562000000000003c02602a3226e65742e636f7264613a534c7758304d6874704f6f574f714c2f42646a2f76513d3d40450080c562000000000005c0e205a12a6e65742e636f7264612e636f72652e7472616e73616374696f6e732e436f6d706f6e656e7447726f757040450080c562000000000003c02602a3226e65742e636f7264613a486e6553504138394d476870697a564c453377634f673d3d40c07f020080c562000000000004c04d07a10a636f6d706f6e656e7473a1012ac03701a1346a6176612e7574696c2e4c6973743c6e65742e636f7264612e636f72652e7574696c69746965732e4f706171756542797465733e404041420080c562000000000004c01907a10a67726f7570496e646578a103696e7445a101304041420080c562000000000006c07206a1346a6176612e7574696c2e4c6973743c6e65742e636f7264612e636f72652e7574696c69746965732e4f706171756542797465733e4045a1046c6973740080c562000000000003c02602a3226e65742e636f7264613a4a597065626c59374372782f61314a6968784a4336773d3d40450080c562000000000005c07f05a1246e65742e636f7264612e636f72652e7574696c69746965732e4f7061717565427974657340450080c562000000000003c02602a3226e65742e636f7264613a706754304b6333742f62766e7a6d67752f6e623443673d3d40c022010080c562000000000004c01507a1056279746573a10662696e61727945404041420080c562000000000005c07f05a1246e65742e636f7264612e636f72652e636f6e7472616374732e5072697661637953616c7440450080c562000000000003c02602a3226e65742e636f7264613a31736b5566426163553141676d4c58384d317a3833413d3d40c022010080c562000000000004c01507a1056279746573a10662696e61727945404041420080c562000000000005c08705a12c6e65742e636f7264612e636f72652e73657269616c697a6174696f6e2e53657269616c697a6564427974657340450080c562000000000003c02602a3226e65742e636f7264613a4c5935355955446a784f38344f6c775377557a7653413d3d40c022010080c562000000000004c01507a1056279746573a10662696e61727945404041420080c562000000000009c101000080c562000000000002d0000008f300000001d0000008ea0000000a0080c562000000000005d00000019700000005a12d6e65742e636f7264612e636f72652e7472616e73616374696f6e732e5369676e65645472616e73616374696f6e40c05e02a1356e65742e636f7264612e636f72652e7472616e73616374696f6e732e5472616e73616374696f6e576974685369676e617475726573a1246e65742e636f7264612e636f72652e636f6e7472616374732e4e616d65644279486173680080c562000000000003c02602a3226e65742e636f7264613a38674f537471464b414a5055656f63667633536553513d3d40c0cf020080c562000000000004c04d07a10473696773a1012ac03d01a13a6a6176612e7574696c2e4c6973743c6e65742e636f7264612e636f72652e63727970746f2e5472616e73616374696f6e5369676e61747572653e404041420080c562000000000004c06907a106747842697473a1596e65742e636f7264612e636f72652e73657269616c697a6174696f6e2e53657269616c697a656442797465733c6e65742e636f7264612e636f72652e7472616e73616374696f6e732e436f72655472616e73616374696f6e3e45404041420080c562000000000005c0cc05a1356e65742e636f7264612e636f72652e7472616e73616374696f6e732e5472616e73616374696f6e576974685369676e61747572657340c05e02a1356e65742e636f7264612e636f72652e7472616e73616374696f6e732e5472616e73616374696f6e576974685369676e617475726573a1246e65742e636f7264612e636f72652e636f6e7472616374732e4e616d65644279486173680080c562000000000003c02602a3226e65742e636f7264613a326e41485a354f6d49724e6c6a366c494972485545773d3d40450080c562000000000005c08405a1246e65742e636f7264612e636f72652e636f6e7472616374732e4e616d656442794861736840c02701a1246e65742e636f7264612e636f72652e636f6e7472616374732e4e616d65644279486173680080c562000000000003c02602a3226e65742e636f7264613a744a78774e6b75764b72494276646c7261624a4a56513d3d40450080c562000000000006c07806a13a6a6176612e7574696c2e4c6973743c6e65742e636f7264612e636f72652e63727970746f2e5472616e73616374696f6e5369676e61747572653e4045a1046c6973740080c562000000000003c02602a3226e65742e636f7264613a472b4967336176636a65344b586b337772636a4445513d3d40450080c562000000000005d00000019700000005a12a6e65742e636f7264612e636f72652e63727970746f2e5472616e73616374696f6e5369676e617475726540c03e01a13b6a6176612e6c616e672e436f6d70617261626c653c6e65742e636f7264612e636f72652e7574696c69746965732e4279746553657175656e63653e0080c562000000000003c02602a3226e65742e636f7264613a7966622b3236685a4e3857346f3345716c635a366a673d3d40c0f2040080c562000000000004c02807a1026279a1012ac01a01a1176a6176612e73656375726974792e5075626c69634b6579404041420080c562000000000004c01507a1056279746573a10662696e61727945404041420080c562000000000004c04207a1117061727469616c4d65726b6c6554726565a1276e65742e636f7264612e636f72652e63727970746f2e5061727469616c4d65726b6c655472656545404042420080c562000000000004c04207a1117369676e61747572654d65746164617461a1276e65742e636f7264612e636f72652e63727970746f2e5369676e61747572654d6574616461746145404041420080c562000000000005c0b205a13b6a6176612e6c616e672e436f6d70617261626c653c6e65742e636f7264612e636f72652e7574696c69746965732e4279746553657175656e63653e40c03e01a13b6a6176612e6c616e672e436f6d70617261626c653c6e65742e636f7264612e636f72652e7574696c69746965732e4279746553657175656e63653e0080c562000000000003c02602a3226e65742e636f7264613a4377734969646a6d6a547a4863757161654777456a773d3d40450080c562000000000005c0ae05a1276e65742e636f7264612e636f72652e63727970746f2e5061727469616c4d65726b6c655472656540450080c562000000000003c02602a3226e65742e636f7264613a515a464f3473386e672f6a6e654f7836614339352f513d3d40c04e010080c562000000000004c04107a104726f6f74a1336e65742e636f7264612e636f72652e63727970746f2e5061727469616c4d65726b6c6554726565245061727469616c5472656545404041420080c562000000000005c06b05a1336e65742e636f7264612e636f72652e63727970746f2e5061727469616c4d65726b6c6554726565245061727469616c5472656540450080c562000000000003c02602a3226e65742e636f7264613a716f4c4c6843593137505a77564e52364557786642673d3d40450080c562000000000005c0b405a1276e65742e636f7264612e636f72652e63727970746f2e5369676e61747572654d6574616461746140450080c562000000000003c02602a3226e65742e636f7264613a497a46743863524b7974734a713376512b796a7347673d3d40c054020080c562000000000004c01e07a10f706c6174666f726d56657273696f6ea103696e7445a101304041420080c562000000000004c01d07a10e736368656d654e756d6265724944a103696e7445a101304041420080c562000000000005c0f305a1596e65742e636f7264612e636f72652e73657269616c697a6174696f6e2e53657269616c697a656442797465733c6e65742e636f7264612e636f72652e7472616e73616374696f6e732e436f72655472616e73616374696f6e3e40c03e01a13b6a6176612e6c616e672e436f6d70617261626c653c6e65742e636f7264612e636f72652e7574696c69746965732e4279746553657175656e63653e0080c562000000000003c02602a3226e65742e636f7264613a4c4f3042534e2b3378334a4e354f4d724d4e55376a413d3d40c022010080c562000000000004c01507a1056279746573a10662696e61727945404041420080c562000000000009c10100"


contract.only('CordaStore.sol', (accounts) => {
    let ion;
    let storage;
//    let rlpEncodedBlock_Gen = "0x" + rlp.encode(formattedData).toString('hex');

    beforeEach('setup contract for each test', async function () {
        ion = await MockIon.new(DEPLOYEDCHAINID);
        storage = await CordaStore.new(ion.address);
    })

    describe('Register Chain', () => {
        it('Successful Register Chain', async () => {
            // Successfully add id of another chain
            await ion.addChain(storage.address, TESTCHAINID);

            let chainRegistered = await storage.m_chains(TESTCHAINID);
            assert(chainRegistered);

            let chainId = await storage.m_networks.call(TESTCHAINID);
            assert.equal(TESTCHAINID, chainId);
        })

        it('Fail Register Current Chain', async () => {
            // Fail adding deployment chain id
            await ion.addChain(storage.address, DEPLOYEDCHAINID).should.be.rejected;
        })

        it('Fail Register Chain Twice', async () => {
            // Successfully add id of another chain
            await ion.addChain(storage.address, TESTCHAINID);

            let chainRegistered = storage.m_chains(TESTCHAINID);
            assert(chainRegistered);

            await ion.addChain(storage.address, TESTCHAINID).should.be.rejected;
        })
    })

    describe.only('Add Block', () => {
        it('Successful Add Block', async () => {
            // Successfully add id of another chain
            await ion.addChain(storage.address, TESTCHAINID);

            let receipt = await ion.storeBlock(storage.address, TESTCHAINID, rlpEncodedBlock);
            console.log("Gas used to store fabric block: %d", receipt.receipt.gasUsed);

            let block = await storage.getBlock.call(TESTCHAINID, TESTDATA[0].channelId, TESTDATA[0].blocks[0].hash);

        })


    })
})